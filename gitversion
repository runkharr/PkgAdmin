#! /bin/bash
# version
#
# $Id$
#
# Author: Boris Jakubith
# E-Mail: runkharr@googlemail.com
# Copyright: (c) 2025, Boris Jakubith <runkharr@googlemail.com>
# License: GNU General Public License, version 2
#
# Small script for generating the header file `version.h` from a GIT
# version number

PROG="$(basename "$0")"
PPATH="$(realpath "$(dirname "$0")")"

REPOVER="$PPATH/repover"

DEF_VERSION=0.0.1
if ! VERSION="$("$REPOVER" 2>/dev/null debian)"; then
    echo "${PROG}: No GIT version available. Using $DEF_VERSION"
    VERSION="$DEF_VERSION"
fi

fail() {
    local exc=1
    if [ $# -gt 0 ] && [[ "$1" =~ ^([0-9]|[1-9][0-9]+)$ ]]; then
	exc="$1"; shift
    fi
    [ $# -lt 1 ] || echo 1>&2 "${PROG}:" "$@"
    exit $((exc))
}

usage() {
    [ $# -lt 1 ] || fail 64 "$@"
    cat <<EOT
Usage: ${0@Q} get
       ${0@Q} header [outfile]
       ${0@Q} [help]
EOT
    exit 0
}

genhdr() {
    local hfile="$1" version="$2" hfname hmac
    if [ -e "$hfile" ]; then
	if [ -h "$hfile" ] || ! [ -f "$hfile" ]; then
	    fail "${hfile@Q} exists and is not a regular file."
	fi
	echo 1>&2 "WARNING! Overwriting ${hfile@Q}"
    fi
    hfname="$(basename "$hfile")"
    hmac="$(echo "$hfname" | tr 'a-z.-' 'A-Z__')"
    cat > "$hfile" <<EOT
/* $hfname
**
** Version number header file.
**
** AUTOMATICALLY GENERATED FILE. DON'T MODIFY IT.
** File generated by: $0 header ${hfile@Q}
**
*/
#ifndef $hmac
#define $hmac

#define VERSION "$VERSION"

#endif /*$hmac*/
EOT
}

[ $# -gt 0 ] || usage

outfile=version.h
case "$1" in
    (get)
	shift; echo "$VERSION" ;;
    (head|header)
	shift; if [ $# -gt 0 ]; then outfile="$1"; shift; fi
	genhdr "$outfile" "$version"
	;;
    (help)
	usage ;;
    (*) usage "Invalid $PROG sub-command; use \`$PROG help\` for help, please!"
esac
