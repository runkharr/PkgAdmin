#! /bin/sh
#
# $Id: distfile,v 1.8 2008-05-16 16:01:41 bj Exp $
#
# Author: Boris Jakubith
# E-Mail: bj@isv-gmbh.de
# Copyright: © 2005, Boris Jakubith <bj@isv-gmbh.de>
# Licence: GPL(v2)

prog="$0"

if ! [ -d admin -a -f VERSION ]; then
    cat 1>&2 <<-EOT
	${prog}: you are probably in the wrong directory.
    	EOT
    exit 64
fi

if ! [ -f admin/version -a -f Makefile ]; then
    cat 1>&2 <<-EOT
	${prog}: are you sure you are exceuting me in the right environment?
	EOT
    exit 64
fi

VERSION=`cat VERSION`

usage () {
    cat <<-EOT
	Usage: $prog [-v] bindist [-<arcmode>] install-prefix" 1>&2
	       $prog [-v] srcdist [-<arcmode>]" 1>&2
	       $prog

	arcmode:
	    gz, gzip
	       use a combination of 'tar' and 'gzip' for archiving
	    bz2, bzip2
	       use a combination of 'tar' and 'bzip2' for archiving
	    lzma
	       use a combination of 'tar' and 'lzma' for archiving
	    zip
	       use 'zip' for archiving
	    7z, 7zip
	       use '7z' for archiving
	EOT
    exit 0
}

vbegin () {
    if [ $VERBOSE -ne 0 ]; then
	echo "Creating $1 archive ($ARCMODE${COMPRESS+, }$COMPRESS)"
    else
	echo -n "Creating $1 archive "
    fi
}

vecho () {
    if [ $VERBOSE -ne 0 ]; then
	echo ${1+"$@"}
    else
	echo -n '.'
    fi
}

vdone () {
    if [ $VERBOSE -ne 0 ]; then
	echo "  archive file = $1"
	echo "done."
    else
	echo ". ($1) done."
    fi
}

VERBOSE=0; if [ $# -gt 0 -a "x$1" = "x-v" ]; then VERBOSE=1; shift; fi

if [ $# -lt 1 ]; then usage; fi

SFX=.tar; SF2=.gz
ARCMODE="tar cf"
COMPRESS="gzip -9f"

op="$1"; shift

if [ $# -gt 0 ]; then
    case $1 in
        -bz2|-bzip2)
            SFX=.tar; SF2=.bz2; ARCMODE="tar cf"; COMPRESS="bzip2 -9f"; shift
            ;;
        -gz|-gzip)
            SFX=.tar; SF2=.gz; ARCMODE="tar cf"; COMPRESS="gzip -9f"; shift
            ;;
        -zip)
            SFX=.zip; ARCMODE="zip -9rq"; unset COMPRESS SF2; shift
            ;;
	-lzma)
	    SFX=.tar; SF2=.lzma; ARCMODE="tar cf"; COMPRESS="lzma -9f"; shift
	    ;;
	-7z|-7zip)
	    SFX=.7z; ARCMODE="7z a -mx=9"; unset COMPRESS SF2
	    shift
	    ;;
        -*)
            echo "${0##*/}: unknown archive mode '$1'."; exit 64
            ;;
	*) ;;
    esac
fi
if [ "$op" = "bindist" -a $# -gt 0 ]; then
    pfx="PREFIX=$1"; shift
fi


case $op in
    srcdist)
	vbegin 'source'
	DISTDIR=`admin/version directory`
	vecho "  creating temporary directory"
	mkdir "$DISTDIR"
	vecho "  copying files"
	find . \( -path '*/CVS/*' -o -path '*/CVS' \) -prune -o \
	       \( -path "./$DISTDIR/*" -o -path "./$DISTDIR" \) -prune -o \
	       -print \
	| cpio -pdm "$DISTDIR" >/dev/null 2>&1
	vecho "  cleaning up directory"
	(cd "$DISTDIR"; make cleanall >/dev/null 2>&1)
	arcname="${DISTDIR}$SFX"
	atmp=.; abck=.; adir="$DISTDIR"
	;;
    bindist)
	vbegin 'binary'
	DISTDIR="`admin/version directory`.bin" 
	vecho "  creating temporary directory"
	mkdir "$DISTDIR"
	vecho "  binary install into temporary directory"
	if [ -z "$pfx" ]; then
	    if ! make "DESTDIR=$DISTDIR" install-root >/dev/null 2>&1; then
		make "DESTDIR=$DISTDIR" install >/dev/null 2>&1
	    fi
	else
	    if ! make "DESTDIR=$DISTDIR" "$pfx" install-root >/dev/null 2>&1
	    then
		make "DESTDIR=$DISTDIR" "$pfx" install >/dev/null 2>&1
	    fi
	fi
	arcname="${DISTDIR}$SFX"
	atmp="$DISTDIR"; abck=..; adir="."
	;;
    *)  usage ;;
esac

vecho "  archiving"
(cd "$atmp"; $ARCMODE >/dev/null "$abck/$arcname" "$adir")
carcname="${arcname}$SF2"
if [ -n "$COMPRESS" ]; then
    vecho "  compressing"
    $COMPRESS "$arcname"
fi
vecho "  removing temporary directory"
rm -rf "$DISTDIR"
vecho "  moving archive outside of `pwd`"
mv "$carcname" ..
vdone "../$carcname"
